---
title: "Barcode validation analysis"
author: '@rvosa'
date: "2025-02-23"
output: pdf_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)
library(viridis)  # For color-blind friendly palettes
library(cowplot)  # For publication-ready plots
library(scales)   # For nice axis formatting

# Set default theme for all plots
theme_set(
  theme_minimal(base_size = 12) +
  theme(
    text = element_text(family = "Arial"),
    plot.title = element_text(size = 14, face = "bold"),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10)
  )
)

# Define standard figure dimensions (in inches)
fig_width <- 8
fig_height <- 6

# Define project color palette using viridis
project_colors <- scale_color_viridis(discrete = TRUE)
project_fills <- scale_fill_viridis(discrete = TRUE)

# Set up common plot saving parameters
save_plot <- function(filename, plot, width = fig_width, height = fig_height) {
  ggsave(
    filename = file.path("figures", filename),
    plot = plot,
    width = width,
    height = height,
    dpi = 300
  )
}
```

# BGE Project Milestone MS8.4.1: DNA Barcode Validation Analysis

## Analysis Overview

This document presents a comprehensive analysis of DNA barcode validation 
results from the BGE project, combining outputs from two institutions (Naturalis 
and Natural History Museum) with BOLD spreadsheet data. The analysis is 
structured around four key areas:

1. **MGE Parameter Space Analysis**: Evaluating how different pipeline 
   parameters (r, s combinations) affect barcode recovery success and quality.
2. **Quality Metrics Analysis**: Investigating the distribution and 
   relationships between various sequence quality indicators and assembly 
   metrics.
3. **Temporal Analysis**: Examining how specimen age influences barcode 
   recovery success and quality metrics.
4. **Taxonomic Analysis**: Analyzing success rates and failure patterns across 
   different taxonomic groups.

Each section includes data visualization and statistical analysis to support 
findings relevant to optimizing the MGE pipeline and understanding factors 
affecting DNA barcode recovery from historical specimens.

## Loading Data and Metadata

We start by loading the outputs of the barcode validation pipeline for NHM
and Naturalis.

```{r data_loading}
source("functions/data_loading.R")

validation_data <- load_validation_data(
  nhm_path = "../data/concatenated_untriaged.tsv",
  naturalis_path = "../data/concat_naturalis.tsv"
)
```

We then join this data with BOLD lab sheets to enrich the validation data with
the expected taxonomy and collection date.

```{r preprocessing}
source("functions/preprocessing.R")

joined_data <- join_validation_taxonomy(
  validation_data,
  lab_sheet_path = "../data/lab_sheet.tsv",
  taxonomy_path = "../data/taxonomy.tsv"
)

# Create directory for figures if it doesn't exist
if (!dir.exists("figures")) {
  dir.create("figures")
}
```

Finally, we process the data further to extract some MGE parameter values from
Naturalis' sequence IDs.

```{r parameters}
source("functions/parameter-parsing.R")
```

## Applying Validation

We define sequence validation success based on five key criteria:

1. No more than 6 ambiguous bases in barcode region
2. Barcode region length of at least 500 bp
3. No processing errors
4. No stop codons in translation
5. Expected family found in BLAST results

```{r}
source("functions/add-is_valid.R")
```

Here we plot how this went:

```{r}
source("functions/plot-raw-success.R")

# Display process-level summary
knitr::kable(process_level_summary,
             digits = 1,
             col.names = c("Institution", "Total Specimens", "Valid Specimens", 
                           "Success Rate (%)", "Avg Attempts/Specimen"),
             caption = "Validation success rates at Process ID level by institution")
```

## MGE parameter analysis

Now we investigate the effect of the MGE parameters. We produce:

1. A heatmap showing validation success rates across parameter combinations for 
  both institutions
2. A detailed breakdown plot showing:
   - Overall validation success
   - Individual failure mode rates
   - For each parameter combination and institution
3. Statistical analysis to quantify:
   - Parameter effects
   - Institution differences
   - Parameter-institution interactions
4. A summary table of optimal parameters for each institution

```{r mge}
source("functions/mge-params.R")
```
